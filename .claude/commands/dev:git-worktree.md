# /dev:git-worktree - Git Worktree 관리

여러 에이전트에서 병렬 작업을 위한 Git Worktree를 생성하고 관리합니다.

## 개요

Git Worktree를 사용하면 하나의 저장소에서 여러 작업 디렉토리를 동시에 사용할 수 있습니다. 각 Claude Code 세션이 독립적인 Worktree에서 작업하여 병렬 작업이 가능합니다.

## 작업 흐름

### 1. Worktree 상태 확인

먼저 현재 디렉토리의 Git 상태를 확인합니다:

```bash
# 현재 디렉토리가 worktree인지 확인
git rev-parse --git-dir

# Worktree 목록 확인
git worktree list
```

**판단 기준**:
- `.git` 디렉토리 → 메인 저장소
- `.git` 파일 → Worktree

### 2-A. 메인 저장소에서 실행: Worktree 생성

현재 디렉토리가 메인 저장소인 경우:

#### 단계 1: 작업 정보 수집

AskUserQuestion으로 다음 정보 수집:

**질문 1**: "어떤 작업을 하시나요?"
- 옵션:
  - "새 기능 개발" (feature)
  - "버그 수정" (bugfix)
  - "리팩토링" (refactor)
  - "실험/테스트" (experiment)

**질문 2**: "작업 이름을 입력하세요" (자유 입력)
- 예: "image-optimization", "add-tts-engine"

#### 단계 2: Worktree 생성

```bash
# 브랜치 이름 생성
BRANCH_NAME="worktree/{작업타입}/{작업이름}"
# 예: worktree/feature/image-optimization

# Worktree 디렉토리 이름
WORKTREE_DIR="../ac3-worktrees/{작업이름}"
# 예: ../ac3-worktrees/image-optimization

# Worktree 생성
git worktree add "$WORKTREE_DIR" -b "$BRANCH_NAME"
```

#### 단계 3: 사용자 안내

```
✅ Worktree 생성 완료!

📂 디렉토리: {WORKTREE_DIR}
🌿 브랜치: {BRANCH_NAME}

⏭️ 다음 단계:
1. 새 터미널 열기
2. 다음 명령어 실행:
   cd {WORKTREE_DIR}
   code .
3. 새 Claude Code 세션에서 작업 시작

💡 팁: 여러 Worktree를 만들어 병렬 작업이 가능합니다!
```

### 2-B. Worktree에서 실행: 머지 및 정리

현재 디렉토리가 Worktree인 경우:

#### 단계 1: 변경사항 확인

```bash
# 현재 브랜치 확인
git branch --show-current

# 변경사항 확인
git status --short

# 커밋 히스토리 확인
git log main..HEAD --oneline
```

#### 단계 2: 커밋되지 않은 변경사항 처리

변경사항이 있으면:
1. 커밋 여부 확인 (AskUserQuestion)
2. 커밋 선택 시: `/dev:git-commit` 로직 실행

#### 단계 3: 머지 전략 선택

AskUserQuestion으로 머지 방식 선택:

**질문**: "어떻게 메인 브랜치에 머지하시겠습니까?"
- 옵션:
  - "Squash Merge (권장)" - 모든 커밋을 하나로 합침
    - description: "여러 커밋을 하나의 깔끔한 커밋으로 정리합니다. 실험적인 커밋이 많을 때 권장합니다."
  - "Regular Merge" - 커밋 히스토리 유지
    - description: "모든 커밋 히스토리를 보존합니다. 체계적으로 커밋했을 때 적합합니다."
  - "Rebase" - 커밋을 main 위에 재배치
    - description: "선형 히스토리를 유지합니다. 충돌 가능성이 있습니다."

#### 단계 4: 메인 브랜치 최신화 및 머지

```bash
# 메인 저장소 경로 확인
MAIN_DIR=$(git worktree list | grep "(bare)\|(main)" | awk '{print $1}')

# 현재 브랜치 이름
CURRENT_BRANCH=$(git branch --show-current)

# 메인 브랜치 최신화
cd "$MAIN_DIR" && git checkout main && git pull

# 머지 실행
case $MERGE_TYPE in
  "squash")
    git merge --squash "$CURRENT_BRANCH"
    # 커밋 메시지 자동 생성 (변경사항 분석)
    git commit -m "$(cat <<'EOF'
[작업타입] 작업 요약

변경사항:
- ...

🤖 Generated by AC3 (Worktree Merge)
EOF
)"
    ;;
  "regular")
    git merge "$CURRENT_BRANCH" --no-ff
    ;;
  "rebase")
    git rebase "$CURRENT_BRANCH"
    ;;
esac
```

#### 단계 5: Worktree 정리

AskUserQuestion으로 Worktree 삭제 여부 확인:

**질문**: "Worktree를 삭제하시겠습니까?"
- 옵션:
  - "예, 삭제합니다" - Worktree 삭제
  - "아니오, 유지합니다" - Worktree 유지 (추가 작업 가능)

삭제 선택 시:
```bash
# Worktree 제거
git worktree remove .

# 브랜치 삭제 여부 확인 (AskUserQuestion)
# "예" 선택 시:
cd "$MAIN_DIR" && git branch -d "$CURRENT_BRANCH"
```

#### 단계 6: 결과 요약

```
✅ Worktree 머지 완료!

📝 머지 정보:
- 브랜치: {CURRENT_BRANCH}
- 머지 타입: {MERGE_TYPE}
- 커밋 수: {COMMIT_COUNT}개

🗑️ 정리:
- Worktree 삭제: ✅
- 브랜치 삭제: ✅

⏭️ 다음 단계:
1. 메인 저장소로 돌아가기: cd {MAIN_DIR}
2. 변경사항 확인: git log -1 --stat
3. 원격 저장소에 푸시: git push
```

## Worktree 목록 조회

Worktree 상태를 확인하고 싶을 때:

```bash
# 모든 Worktree 목록
git worktree list

# 특정 Worktree 정보
git worktree list | grep "worktree/"
```

정보 표시:
```
📂 현재 활성 Worktree:

1. ac3 (main)
   경로: /Users/jusunkim/ac3
   브랜치: main

2. image-optimization
   경로: /Users/jusunkim/ac3-worktrees/image-optimization
   브랜치: worktree/feature/image-optimization

3. tts-engine
   경로: /Users/jusunkim/ac3-worktrees/tts-engine
   브랜치: worktree/feature/tts-engine
```

## 주의사항

### Worktree 생성 시
- ✅ 메인 저장소에서만 실행 가능
- ✅ 각 Worktree는 독립적인 브랜치 사용
- ✅ Worktree 디렉토리는 전용 폴더에 생성 (`../ac3-worktrees/`)
- ⚠️ 동일한 브랜치를 여러 Worktree에서 사용 불가

### Worktree 머지 시
- ✅ 머지 전 반드시 변경사항 커밋
- ✅ Squash Merge 권장 (히스토리 정리)
- ⚠️ 충돌 발생 시 수동 해결 필요
- ⚠️ 메인 브랜치 최신화 후 머지

### 병렬 작업 시
- ✅ 서로 다른 파일 수정 권장
- ⚠️ 같은 파일 수정 시 충돌 가능
- 💡 작업 범위를 명확히 구분

## 사용 예시

### 예시 1: 이미지 최적화 작업

**메인 저장소**:
```
/dev:git-worktree
→ 작업 선택: "새 기능 개발"
→ 작업 이름: "image-optimization"
→ Worktree 생성: ../ac3-worktrees/image-optimization
```

**새 터미널**:
```bash
cd ../ac3-worktrees/image-optimization
code .
# 작업 수행...
```

**작업 완료 후**:
```
/dev:git-worktree
→ 머지 방식: "Squash Merge"
→ Worktree 삭제: "예"
→ 브랜치 삭제: "예"
```

### 예시 2: 3개 병렬 작업

**터미널 1 (메인)**:
```
/dev:git-worktree → feature/ui-redesign
```

**터미널 2**:
```bash
cd ../ac3-worktrees/ui-redesign
/dev:git-worktree → feature/api-integration
```

**터미널 3**:
```bash
cd ../ac3-worktrees/api-integration
# 작업...
```

각 터미널에서 독립적으로 작업하고, 완료 시 `/dev:git-worktree`로 머지합니다.

## 고급 사용법

### Worktree 직접 관리

```bash
# Worktree 추가
git worktree add ../my-worktree -b my-branch

# Worktree 제거
git worktree remove ../my-worktree

# Worktree 정리 (삭제된 디렉토리 정보 제거)
git worktree prune

# Worktree 이동
git worktree move ../old-path ../new-path
```

### 충돌 해결

Squash Merge 시 충돌 발생:
```bash
# 충돌 파일 확인
git status

# 수동 해결 후
git add .
git commit -m "Resolve merge conflicts"
```

## 구현 세부사항

### 현재 위치 판단

```bash
# Git 디렉토리 타입 확인
GIT_DIR=$(git rev-parse --git-dir)

if [ -f "$GIT_DIR" ]; then
  echo "Worktree"
  IS_WORKTREE=true
else
  echo "Main Repository"
  IS_WORKTREE=false
fi
```

### 브랜치 이름 규칙

```
worktree/{타입}/{작업명}

타입:
- feature: 새 기능
- bugfix: 버그 수정
- refactor: 리팩토링
- experiment: 실험/테스트

예:
- worktree/feature/image-optimization
- worktree/bugfix/tts-crash
- worktree/refactor/code-cleanup
```

### 디렉토리 명명 규칙

```
../ac3-worktrees/{작업명}

예:
- ../ac3-worktrees/image-optimization
- ../ac3-worktrees/tts-crash
- ../ac3-worktrees/code-cleanup
```

### 커밋 메시지 생성 (Squash Merge)

```bash
# 변경된 파일 분석
git diff main..HEAD --name-status

# 커밋 히스토리 요약
git log main..HEAD --oneline

# 자동 생성 커밋 메시지
cat <<EOF
[{작업타입}] {작업 요약}

변경사항:
$(git diff main..HEAD --name-status | awk '{print "- " $2 ": " $1}')

커밋 수: $(git log main..HEAD --oneline | wc -l)개

🤖 Generated by AC3 (Worktree Merge)
EOF
```

## 트러블슈팅

### "worktree already exists" 오류

같은 이름의 Worktree가 이미 존재:
```bash
# 기존 Worktree 확인
git worktree list

# 삭제 후 재생성
git worktree remove ../ac3-worktrees/{name}
```

### "branch already exists" 오류

같은 브랜치가 이미 존재:
```bash
# 브랜치 확인
git branch -a | grep worktree/

# 강제 생성 (주의!)
git worktree add ../ac3-worktrees/{name} -B worktree/{type}/{name}
```

### Worktree 디렉토리 수동 삭제 후 오류

```bash
# Worktree 정보 정리
git worktree prune

# 상태 확인
git worktree list
```

### 머지 충돌

```bash
# 충돌 확인
git status

# 머지 중단
git merge --abort

# 또는 수동 해결 후
git add .
git merge --continue
```

## 참고 자료

- Git Worktree 공식 문서: https://git-scm.com/docs/git-worktree
- Git 병렬 작업 가이드: https://git-scm.com/book/en/v2/Git-Tools-Working-with-Multiple-Branches
